<html>
<head>
  <meta name="viewport" content="width=device-width"/>
  <title>Halaman Login</title>
  <link rel="shortcut icon" href="../Content/User/logo3.png">
  <link rel="stylesheet" href="../Content/Plugins/bootstrap-4.0.0-alpha.6-dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../Content/Content/jquery.fancybox.css">
  <link rel="stylesheet" href="../Content/Content/bootstrap-select.min.css">
  <link href="../Content/Plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../Content/Styles/style.css"/>
  <!--    <link rel="stylesheet" href="../Content/User/css/bootstrap.min.css">-->
  <!--    <link rel="stylesheet" href="../Content/site.css"/>-->
  <script type="text/javascript">
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })

    $(function () {
      $('[rel="tooltip"]').tooltip()
    })
  </script>
  <!--
      <link rel="stylesheet" href="~/lib/sweetalert2/sweetalert2.min.css"/>
  -->
  <!--
      <script src="~/lib/jquery/dist/jquery.min.js"></script>
      <script src="~/lib/bootstrap/dist/js/tether.min.js"></script>
      <script src="~/lib/bootstrap/dist/js/bootstrap.min.js"></script>
  -->
  <!--
      <script src="~/lib/sweetalert2/sweetalert2.all.min.js"></script>
  -->
</head>
<body style="background-image: url('../Content/Images/IMG_Background.jpg'); background-repeat: no-repeat; background-size: cover;">

<div>
  <div class="polman-nav-static-top" style="opacity: 0.9;">
    <div class="float-left">
      <a asp-action="Login">
        <img src="../Content/Images/IMG_Logo_astratech.png" style="height: 45px; margin-top: 5px;"/>
      </a>
    </div>
  </div>
  <div class="polman-form-login">
    <h4>Login</h4>
    <hr>
    <div class="form-group">
      <label for="nim">Nama Akun <span style="color: red;">*</span></label>
      <span id="MainContent_reqTxtUsername" style="color:Red;display:none;"> harus diisi</span>
      <input name="ctl00$MainContent$txtUsername" type="text" id="nim" class="form-control">
    </div>
    <div class="form-group">
      <label for="txtPassword">Kata Sandi <span style="color: red;">*</span></label>
      <span id="MainContent_reqTxtPassword" style="color:Red;display:none;"> harus diisi</span>
      <input name="ctl00$MainContent$txtPassword" type="password" id="txtPassword" class="form-control">
    </div>
    <!--<div class="form-group">
        <div class="row">
            <div class="col-lg-12">
                <label for="txtCaptcha">Captcha <span style="color: red;">*</span></label>
                <span id="MainContent_reqTxtCaptcha" style="color:Red;display:none;"> harus diisi</span>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <img id="MainContent_imgCaptcha" src="https://sia.polytechnic.astra.ac.id/sso/Captcha.ashx"
                     style="padding-bottom: 5px;">
            </div>
            <div class="col-lg-6">
                <div class="input-group">
                    <span class="input-group-addon" style="background-color: #0275d8; padding: 0;">
                        <a id="MainContent_btnReloadCaptcha" class="btn btn-primary" data-toggle="tooltip"
                           data-placement="bottom" title=""
                           href="javascript:__doPostBack('ctl00$MainContent$btnReloadCaptcha','')"
                           style="padding: 7px 13px 7px 13px;" data-original-title="Perbarui Captcha"><i
                                class="fa fa-refresh"></i></a>
                    </span>
                    <input name="ctl00$MainContent$txtCaptcha" type="text" id="txtCaptcha"
                           class="form-control text-center">
                </div>
            </div>
        </div>
    </div>-->
    <input type="submit" value="Masuk"
           onclick="Login()" class="btn btn-primary"
           style="width: 100%; margin-top: 10px; margin-bottom: 10px;">
  </div>
  <div class="polman-nav-static-bottom">
    Copyright &copy; <span id="year"></span> - Patrick, Bunga, Tasya, Izzat
  </div>
</div>

<script src="../Content/Scripts/tether/tether.min.js"></script>
<script src="../Content/Scripts/jquery-3.7.0.min.js"></script>
<script src="../Content/Scripts/jquery-ui-1.13.2.min.js"></script>
<script src="../Content/Plugins/bootstrap-4.0.0-alpha.6-dist/js/bootstrap.min.js"></script>
<script src="../Content/Scripts/tinymce/tinymce.min.js"></script>
<script src="../Content/Scripts/jquery.fancybox.pack.js"></script>
<script src="../Content/Scripts/bootstrap-select.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>


<script type="text/javascript">
  // year now
  document.getElementById("year").innerHTML = new Date().getFullYear();


  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })

  $(function () {
    $('[rel="tooltip"]').tooltip()
  })

  $(function () {
    $('[data-toggle="popover"]').popover()
  })

  function redirectNotifikasi() {
    window.location.href = 'Page_Notifikasi.aspx';
  }

  function sentValidation(input) {
    $(input).addClass('disabled');
    $(input).text('Mohon tunggu..');
  }

  function pageLoad(sender, args) {
    $('.selectpicker').selectpicker();
  }

  function showModalKey() {
    $('#changeModal').modal({ backdrop: 'static', keyboard: false });
  }
</script>
<style>
  .mce-branding-powered-by {
    display: none;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  /*@if
  (TempData["Notifikasi"] != null)
  {
      <text>
          Swal.fire({
          icon: '@TempData["Icon"]',
          title: '@TempData["Notifikasi"]',
          showConfirmButton: false,
          timer: 1000,

      })
      </text>
  }*/

  //function buat login
  function Login() {
    var NIM = document.getElementById("nim").value;
    var password = document.getElementById("txtPassword").value;

    $.ajax({
      url: "https://api.polytechnic.astra.ac.id:2906/api_dev//AccessToken/Get",
      type: "POST",
      dataType: 'json',
      contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
      data: {
        "grant_type": "password",
        "username": NIM,
        "password": password
      },
      success: function (data) {
        var token = data.access_token;
        var settings = {
          "url": "https://api.polytechnic.astra.ac.id:2906/api_dev/efcc359990d14328fda74beb65088ef9660ca17e/SIA/LoginSIA?username=" + NIM + "&password=" + password,
          "method": "POST",
          "timeout": 0,
          "headers": {
            "Authorization": "Bearer " + token,
          },
        };

        $.ajax(settings).done(function (response) {
          var npk = response.npk;
          var nama = response.nama;
          var username = response.username;
          var role = response.role;
          var prodi = response.jabatan;
          const d = new Date();
          d.setTime(d.getTime() + (1 * 24 * 60 * 60 * 1000));
          let expires = "expires=" + d.toUTCString();
          if (username != "" && username != "undefined") {
            console.log("berhasil");
            document.cookie = "nim=" + username + ";" + expires + "; path=/";
            document.cookie = "nama=" + nama + ";" + expires + ";path=/";
            document.cookie = "prodi=" + prodi + ";" + expires + ";path=/";

            $.ajax({
              url: "http://localhost:8080/getPenggunaByUsername?username=" + NIM,
              success: function (data) {
                role = data.role;
                console.log(role);

                if(role == "Admin"){
                  document.cookie = "role=" + role + ";" + expires + ";path=/";
                  window.location.href = "../User/index.html";
                }else if (role == "Ormawa"){
                  document.cookie = "role=" + role + ";" + expires + ";path=/";
                  window.location.href = "../User/index.html";
                }else if(role == "Super Admin"){
                  document.cookie = "role=" + role + ";" + expires + ";path=/";
                  window.location.href = "../Jabatan/index.html";
                } else if(role == "Mahasiswa") {
                  document.cookie = "role=" + role + ";" + expires + ";path=/";
                  window.location.href = "../Mahasiswa/index.html";
                }
              },
              // error: function(xhr, status, error) {
              //   alert("Terjadi kesalahan");
              // }
            });

            $.ajax({
              url: "http://localhost:8080/getKandidatByUsername?username=" + NIM,
              success: function (data) {
                role = data.role;
                document.cookie = "role=" + role + ";" + expires + ";path=/";
                window.location.href = "../Mahasiswa/index.html";
              },
            });

          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal Login',
              text: 'Username atau Password Salah!',
              showConfirmButton: false,
              timer: 1500,

            })
          }
        });
      },
      error: function (data) {
        console.log("erorr");
      }

    });


  }

  function getCookieValue(cookieName) {
    var name = cookieName + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var cookieArray = decodedCookie.split(";");

    for (var i = 0; i < cookieArray.length; i++) {
      var cookie = cookieArray[i];
      while (cookie.charAt(0) === " ") {
        cookie = cookie.substring(1);
      }
      if (cookie.indexOf(name) === 0) {
        return cookie.substring(name.length, cookie.length);
      }
    }

    return "";
  }

  // Mendapatkan peran dari cookie atau sumber lainnya
  var role = getCookieValue("role"); // Fungsi untuk mendapatkan peran dari cookie
  console.log(role);

  // Daftar elemen sidebar yang perlu diubah berdasarkan peran
  var sidebarElements = [
    { elementId: "logoutLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] },
    { elementId: "dashboardLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] },
    { elementId: "eventLink", allowedRoles: ["Admin", "Super Admin"] },
    { elementId: "userLink", allowedRoles: ["Admin"] },
    { elementId: "kandidatLink", allowedRoles: ["Admin"] },
    { elementId: "informasiLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] }
  ];

  // Menampilkan atau menyembunyikan elemen sidebar berdasarkan peran
  for (var i = 0; i < sidebarElements.length; i++) {
    var element = document.getElementById(sidebarElements[i].elementId);
    if (element && sidebarElements[i].allowedRoles.includes(role)) {
      element.style.display = "block"; // Menampilkan elemen sidebar
    } else {
      element.style.display = "none"; // Menyembunyikan elemen sidebar
    }
  }


  /*function showSidebarBasedOnRole(role) {
    // Daftar elemen sidebar yang perlu diubah berdasarkan peran
    var sidebarElements = [
      { elementId: "logoutLink", allowedRoles: ["Admin", "Ormawa", "Super Admin", "MAHASISWA"] },
      { elementId: "dashboardLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] },
      { elementId: "eventLink", allowedRoles: ["Admin", "Super Admin"] },
      { elementId: "userLink", allowedRoles: ["Admin"] },
      { elementId: "kandidatLink", allowedRoles: ["Admin"] },
      { elementId: "informasiLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] }
    ];

    // Mengubah tampilan sidebar berdasarkan peran
    for (var i = 0; i < sidebarElements.length; i++) {
      var element = document.getElementById(sidebarElements[i].elementId);
      if (element && sidebarElements[i].allowedRoles.includes(role)) {
        element.style.display = "inherit"; // Menampilkan elemen sidebar
      } else {
        element.style.display = "none"; // Menyembunyikan elemen sidebar
      }
    }
  }

  // Mendapatkan peran dari cookie atau sumber lainnya
  var role = getCookieValue("role"); // Fungsi untuk mendapatkan peran dari cookie

  // Menampilkan sidebar berdasarkan peran
  showSidebarBasedOnRole(role);*/


  // Mendapatkan peran dari cookie atau sumber lainnya
  /*var role = getRoleFromCookie(); // Fungsi untuk mendapatkan peran dari cookie

  // Daftar elemen sidebar yang perlu diubah berdasarkan peran
  var sidebarElements = [
    { elementId: "logoutLink", allowedRoles: ["Admin", "Ormawa", "Super Admin", "MAHASISWA"] },
    { elementId: "dashboardLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] },
    { elementId: "eventLink", allowedRoles: ["Admin", "Super Admin"] },
    { elementId: "userLink", allowedRoles: ["Admin"] },
    { elementId: "kandidatLink", allowedRoles: ["Admin"] },
    { elementId: "informasiLink", allowedRoles: ["Admin", "Ormawa", "Super Admin"] }
  ];

  // Mengubah tampilan sidebar berdasarkan peran
  for (var i = 0; i < sidebarElements.length; i++) {
    var element = document.getElementById(sidebarElements[i].elementId);
    if (element && sidebarElements[i].allowedRoles.includes(role)) {
      element.style.display = "inherit"; // Menampilkan elemen sidebar
    } else {
      element.style.display = "none"; // Menyembunyikan elemen sidebar
    }
  }*/

 /* function getRoleFromCookie() {
    // Mendapatkan cookie berdasarkan nama cookie
    function getCookie(name) {
      var cookies = document.cookie.split("; ");
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].split("=");
        if (cookie[0] === name) {
          return cookie[1];
        }
      }
      return "";
    }

    var role = ""; // Peran default jika cookie tidak ditemukan
    var roleCookie = getCookie("role");
    if (roleCookie) {
      role = roleCookie;
    }
    return role;
  }*/


</script>
</body>

</html>